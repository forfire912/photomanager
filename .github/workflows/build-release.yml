name: Build and Release Windows Executable

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build CLI executable
      run: |
        pyinstaller --onefile --name photo-manager-cli --icon=NONE photo_manager.py
        
    - name: Build Web UI executable
      run: |
        pyinstaller --onefile --name photo-manager-web --add-data "templates;templates" --add-data "static;static" --icon=NONE web_ui.py
        
    - name: Create distribution archive
      run: |
        mkdir release
        copy dist\photo-manager-cli.exe release\
        copy dist\photo-manager-web.exe release\
        copy README.md release\
        copy USAGE_WEB.md release\
        copy LICENSE release\
        copy RELEASE_NOTES.md release\
        copy QUICKSTART.md release\
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path release\* -DestinationPath photo-manager-windows-x64.zip
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: |
          dist/photo-manager-cli.exe
          dist/photo-manager-web.exe
          photo-manager-windows-x64.zip
          
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          photo-manager-windows-x64.zip
          dist/photo-manager-cli.exe
          dist/photo-manager-web.exe
        body: |
          ## Photo Manager Windows Release / ç…§ç‰‡ç®¡ç†å·¥å…· Windows å‘å¸ƒç‰ˆ
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜ / Download Instructions
          
          **Windowsç”¨æˆ· / Windows Users:**
          - ä¸‹è½½ `photo-manager-windows-x64.zip` è·å–å®Œæ•´åŒ…ï¼ˆæ¨èï¼‰
          - Download `photo-manager-windows-x64.zip` for the complete package (Recommended)
          - æˆ–å•ç‹¬ä¸‹è½½ / Or download separately:
            - `photo-manager-cli.exe` - å‘½ä»¤è¡Œç‰ˆæœ¬ / CLI version
            - `photo-manager-web.exe` - Webç•Œé¢ç‰ˆæœ¬ / Web UI version
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹ / Quick Start
          
          **å‘½ä»¤è¡Œå·¥å…· / CLI Tool:**
          ```bash
          # æŸ¥æ‰¾é‡å¤æ–‡ä»¶ / Find duplicates
          photo-manager-cli.exe -d C:\Photos --find-duplicates
          
          # åˆ é™¤é‡å¤æ–‡ä»¶ / Remove duplicates
          photo-manager-cli.exe -d C:\Photos --remove-duplicates --execute
          
          # æŒ‰æ—¥æœŸæ•´ç† / Organize by date
          photo-manager-cli.exe -d C:\Photos --organize -o C:\Organized --execute
          ```
          
          **Webç•Œé¢ / Web UI:**
          1. åŒå‡»è¿è¡Œ `photo-manager-web.exe` / Double-click `photo-manager-web.exe`
          2. åœ¨æµè§ˆå™¨æ‰“å¼€ / Open in browser: http://127.0.0.1:5000
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§ / Features
          - âœ… æ‰«æå¹¶æ•´ç†ç…§ç‰‡/è§†é¢‘ / Scan and organize photos/videos
          - âœ… æ£€æµ‹å¹¶åˆ é™¤é‡å¤æ–‡ä»¶ / Detect and remove duplicates
          - âœ… æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†ç±» (YYYY/MM/DD) / Auto-organize by date
          - âœ… Webå¯è§†åŒ–ç•Œé¢ / Web visualization interface
          - âœ… WindowsåŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— éœ€å®‰è£…Python / Native Windows executable, no Python required
          - âœ… æ”¯æŒ16+ç§æ ¼å¼ / Support 16+ formats (JPG, PNG, MP4, MOV, etc.)
          
          ### ğŸ’» ç³»ç»Ÿè¦æ±‚ / System Requirements
          - Windows 10/11 (64-bit)
          - æ— éœ€å®‰è£…Pythonæˆ–å…¶ä»–ä¾èµ– / No Python or dependencies required
          
          ### ğŸ“š æ–‡æ¡£ / Documentation
          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹å‹ç¼©åŒ…ä¸­çš„ README.md å’Œ QUICKSTART.md
          
          For full documentation, see README.md and QUICKSTART.md in the archive
          
          ### ğŸ”— æ›´å¤šä¿¡æ¯ / More Information
          è¯¦ç»†å‘å¸ƒè¯´æ˜è¯·æŸ¥çœ‹: [RELEASE_NOTES.md](https://github.com/forfire912/photomanager/blob/main/RELEASE_NOTES.md)
          
          For detailed release notes, see: [RELEASE_NOTES.md](https://github.com/forfire912/photomanager/blob/main/RELEASE_NOTES.md)
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
